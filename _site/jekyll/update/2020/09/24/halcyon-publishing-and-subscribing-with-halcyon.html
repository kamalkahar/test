<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="http://localhost:4000/assets/img/favicon.png" />
    <title>Real Time Communication, Presence and Messaging Software Provider</title>
    <link rel="stylesheet" href="http://localhost:4000/assets/css/plugins.css">
    <link rel="stylesheet" href="http://localhost:4000/assets/css/style.css">
    <link rel="stylesheet" href="assets/css/style.css">
    
    <link rel="preload" href="http://localhost:4000/assets/css/fonts/thicccboi.css" as="style" onload="this.rel='stylesheet'">
    <style>
        .goog-te-banner-frame {
            display: none !important;
            top: 0px !important;
        }
        
        body {
            top: 0px !important;
        }
        
        .goog-te-gadget span {
            display: none !important;
        }
        
        .goog-logo-link {
            display: none !important;
        }
        
        .goog-te-gadget {
            color: transparent !important;
        }
        
        /* .gtrans {
            position: fixed; right: 110px; top: 30px; z-index: 9999;
        } */
        /* .gtrans {
    position: fixed;
    right: 5%;
    top: 0px;
    z-index: 9999;
} */
.gtrans {
    position: fixed;
    right: 1%;
    top: 0px;
    z-index: 9990;
}

/*
@media (min-width:1400px) {
    .gtrans {
    position: fixed;
    right: 5%;
    top: 65px;
    z-index: 9999;
}
}
@media (min-width:1024px) {
    .gtrans {
    position: fixed;
    right: 16%;
    top: 65px;
    z-index: 9999;
}
} */


        .goog-te-gadget .goog-te-combo {
            margin: 4px 0;
    border: none;
    background-color: rgb(255 255 255 / 0%) !important;
    font-size: 14px;
    font-family: THICCCBOI,sans-serif !important;
    color: #a8afbd !important;
    font-weight: 700 !important;
    font-size: .65rem !important;
}



    </style>
</head>

<!-- start header Arae -->
<div class="gtrans"  id="google_translate_element"></div>
<header class="wrapper bg-soft-primary">
    
  
    
  
    <nav class="navbar center-nav transparent navbar-expand-lg navbar-light">
        <div class="container flex-lg-row flex-nowrap align-items-center">
            <div class="navbar-brand w-100"><a href="index.html"><img src="http://localhost:4000/assets/img/logo.png"  alt="" /></a></div>
            <div class="navbar-collapse offcanvas-nav">
                <div class="offcanvas-header d-lg-none d-xl-none">
                    <a href="#"><img src="http://localhost:4000/assets/img/logo0w.png" alt="" /></a>
                    <button type="button" class="btn-close btn-close-white offcanvas-close offcanvas-nav-close" aria-label="Close"></button>
                </div>
                
                <!--<ul class="navbar-nav">
    <li class="nav-item">
        <a class="nav-link" href="index.html">Home</a>-->
                <!--/.dropdown-menu -->
                <!--</li>
    <li class="nav-item ">
        <a class="nav-link " href="aboutus.html">About</a>

    </li>
    <li class="nav-item ">
        <a class="nav-link " href="https://docs.tigase.net/" target="_blank">Documentation</a>

    </li>
    <li class="nav-item ">
        <a class="nav-link " href="download.html">Download</a>

    </li>
    <li class="nav-item ">
        <a class="nav-link " href="community.html">Community</a>

    </li>
    <li class="nav-item">
        <a class="nav-link" href="developer.html">Developers</a>-->
                <!--/.dropdown-menu -->
                <!--</li>
    <li class="nav-item">
        <a class="nav-link" href="donate.html">Donate</a>-->
                <!--/.dropdown-menu -->
                <!--</li>
    <li class="nav-item">
        <a class="nav-link" href="https://tigase.net/" target="_blank">Enterprise</a>-->
                <!--/.dropdown-menu -->
                <!--</li>
    </ul>-->
                <!-- /.navbar-nav -->

                
                <ul class="navbar-nav">
                    
                    <li class="nav-item"><a class="nav-link" href="/os-website/index">Home</a></li>
                    
                    
                    <li class="nav-item"><a class="nav-link" href="/os-website/aboutus">About</a></li>
                    
                    
                    <li class="nav-item"><a class="nav-link" href="https://docs.tigase.net/">Documentation</a></li>
                    
                    
                    <li class="nav-item"><a class="nav-link" href="/os-website/download">Download</a></li>
                    
                    
                    <li class="nav-item"><a class="nav-link" href="/os-website/community">Community</a></li>
                    
                    
                    <li class="nav-item"><a class="nav-link" href="/os-website/donate">Donate</a></li>
                    
                    
                    <li class="nav-item"><a class="nav-link" href="https://tigase.net/">Enterprise</a></li>
                    
                    
                    <li class="nav-item"><a class="nav-link" href="/os-website/blog">Blog</a></li>
                    
                    
                    <a href="http://localhost:4000/de"> de</a> <br>
                    <a href="http://localhost:4000"> en</a>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
            <div class="navbar-other w-10 d-flex ms-auto">
                <ul class="navbar-nav flex-row align-items-center ms-auto" data-sm-skip="true">
                  
                    <li class="nav-item dropdown language-select text-uppercase">

                        <!-- <a class="nav-link dropdown-item dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">En</a> -->
                        <!-- <ul class="dropdown-menu">
                            <li class="nav-item"><a class="dropdown-item" href="#">En</a></li>
                            <li class="nav-item"><a class="dropdown-item" href="#">De</a></li>
                            <li class="nav-item"><a class="dropdown-item" href="#">Es</a></li>
                        </ul> -->
                    </li>
                    
                    <li class="nav-item"><a class="nav-link" data-toggle="offcanvas-info">
                        <i class="uil uil-info-circle"></i></a></li>
                    <li class="nav-item d-lg-none">
                        <div class="navbar-hamburger"><button class="hamburger animate plain" data-toggle="offcanvas-nav"><span></span></button></div>
                    </li>
                </ul>
                <!-- /.navbar-nav -->
            </div>
            <!-- /.navbar-other -->
        </div>
        <!-- /.container -->
    </nav>
    <!-- /.navbar -->
    <div class="offcanvas-info text-inverse">
        <button type="button" class="btn-close btn-close-white offcanvas-close offcanvas-info-close" aria-label="Close"></button>
        <a href="index.html"><img src="http://localhost:4000/assets/img/logo0w.png" alt="" /></a>
        <div class="mt-4 widget">
            <p style="text-align:justify">Getting started with using XMPP never been easier - pick a project you want to build, and let XMPP safely and robustly store your data.</p>
        </div>
        <!-- /.widget -->
        <div class="widget">
            <h4 class="widget-title text-white mb-3">Contact Info</h4>
            <address>4275 Executive Sq.,<br /> Suite 200, La Jolla,<br /> CA 92037 </address>
            <!--<a href="mailto:info@tigase.net">info@tigase.net</a><br /> <a href="tel:+14159004778">+1 (415) 900-4778</a>-->
            <!-- /.widget -->
            <div class="widget"><br />

                <h4 class="widget-title text-white mb-3">Learn More</h4>
                <ul class="list-unstyled">
                    <li><a href="index.html">Our Story</a></li>
                    <li><a href="index.html">Terms of Use</a></li>
                    <li><a href="index.html">Privacy Policy</a></li>
                    <li><a href="index.html">Contact Us</a></li>
                </ul>
            </div>
            <!-- /.widget -->
            <div class="widget">
                <h4 class="widget-title text-white mb-3">Follow Us</h4>
                <nav class="nav social social-white">
                    <a href="https://twitter.com/tigase" target="_blank"><i class="uil uil-twitter"></i></a>
                    <a href="https://www.facebook.com/tigase" target="_blank"><i class="uil uil-facebook-f"></i></a>

                </nav>
                <!-- /.social -->
            </div>
            <!-- /.widget -->
        </div>
        <!-- /.offcanvas-info -->
        </div>
</header>
<!-- /header -->

<section class="wrapper bg-soft-primary">
    <div class="container pt-10 pb-19 pt-md-14 pb-md-20 text-center">
        <div class="row">
            <div class="col-md-10 col-xl-8 mx-auto">
                <div class="post-header">

                    <!-- /.post-category -->
                    <h1 class="display-1 mb-4">Publishing and Subscribing with Halcyon</h1>
                    <ul class="post-meta mb-5">
                        <li class="post-date"><i class="uil uil-calendar-alt"></i><span>Sep 24, 2020</span></li>

                    </ul>
                    <!-- /.post-meta -->
                </div>
                <!-- /.post-header -->
            </div>
            <!-- /column -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container -->
</section>
<!-- /section -->
<section class="wrapper bg-light">
    <div class="container pb-14 pb-md-16">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <div class="blog single mt-n17">
                    <div class="card">
                        <div class="card-body">
                            <h3>Publishing and Subscribing with Halcyon</h3>

<p>As you recall, Halcyon is multiplatform XMPP library written in Kotlin. In a previous article: ‘A look at Halcyon’ we had a look at basic concepts in library and we created a simple client.<br /></p>

<p>This time we will dive into more complex stuff. We will create simple solution to monitoring temperature at home :-) In this article we will not focus on measuring temperature. We will create a command-line tool to publish temperature provided as parameter.<br /></p>

<p>First letter in XMPP acronym is from the word ‘eXtensible’. There is a lot of extensions for the XMPP protocol. One of them is <a href="https://xmpp.org/extensions/xep-0060.html" style="color:#5a66e8;" target="_blank">XEP-0060: Publish-Subscribe</a> - specification for publish-subscribe functionality. We will use it to create our temperature monitor.<br /></p>

<p>You need to use XMPP Server with PubSub component. You can use your deployment (for example Tigase <a href="https://github.com/tigase/tigase-server/" style="color:#5a66e8;" target="_blank">XMPP Server</a> or use one of the publicly available servers, for example sure.im and its PubSub component pubsub.sure.im. A PubSub node with unique name (to avoid conflicts) will have to be created in the PubSub component. Please note that node created with default configuration is open, which means that everyone can subscribe to it (but only you will be able to publish data there).<br /></p>

<h3>Data structure</h3>
<p>First of all we have to create data structure. In our case, it will be as simple as possible:<br /><br />
<b>&lt;temperature timestamp=”1597946187562”&gt;23.8&lt;/temperature&gt;</b><br /></p>

<p>timestamp is time represented as a number of milliseconds after January 1, 1970 00:00:00 GMT.<br /></p>

<p>We can use DSL (defined in Halcyon) to create such XML fragment:<br /></p>

<pre><b>val payload = element("temperature") {
attributes["timestamp"] = (Date()).time.toString()
+temperature.toString()
}</b></pre>

<h3>Publisher</h3>

<p>Publisher is a simple XMPP client that connects to the server, sends information to PubSub component and immediately disconnects.<br /></p>

<p>First of all, lets define global values to keep node name and PubSUB JID:<br /></p>

<pre><b>val PUBSUB_JID = "pubsub.tigase.org".toJID()
val PUBSUB_NODE = "temperature_in_my_house"</b></pre>

<p>It cannot be called a good practice, but is good enough for us right now :-)<br /></p>

<p>In the previous article we explained how to create a simple client. Now we will focus on PubSubModule. This module allows publishing and receiving events as well as managing PubSub nodes and subscriptions.<br /></p>

<p>This is the main code that publishes events:<br /></p>

<pre><b>pubSubModule.publish(PUBSUB_JID, PUBSUB_NODE, null, payload).handle {
success { request, iq, result -&gt;
println("YAY! Published with id=${result!!.id}")
}
error { request, iq, errorCondition, s -&gt;
System.err.println("ERROR $errorCondition! $s")
}
}.send()
</b></pre>
<p>But what if the PubSub node does’t exist (e.g. it was’t created yet)? It’s simple: we have to create it using method<br />
create():</p>

<p>The question is: under what conditions we should call this part of code and automatically create the node? One of the possibilities would be moment when item publishing fails with error <mark style="background-color&#x3a; &num;f5f2f0;">item-not-found.</mark><br /></p>

<pre><b>
pubSubModule.publish(PUBSUB_JID, PUBSUB_NODE, null, payload).handle {<br />
            success { request, iq, result -&gt;<br />
            println("YAY! Published with id=${result!!.id}")<br />    }<br />
            error { request, iq, errorCondition, s -&gt;<br />
            if (errorCondition == ErrorCondition.ItemNotFound) {<br />
            println("Node not found! We need to create it!")<br />
            pubSubModule.create(PUBSUB_JID, PUBSUB_NODE).handle {<br />
        success { _&#x3a; IQRequest, _&#x3a; IQ, _&#x3a; Unit? -&gt; println("Got it! Node created!") }<br />
      error { _&#x3a; IQRequest, _&#x3a; IQ?, errorCondition&#x3a; ErrorCondition, msgs&#x3a; String? -&gt;<br />
                    println(
                        "OOPS! Cannot create node $errorCondition $msgs"
                    )<br />                } <br />            }.send() <br />        } else System.err.println("ERROR $errorCondition! $s")<br />    }<br />}.send()
                    </b></pre>
<p><br /></p>

<p>To simplify the code, publishing will not be repeated after node creation.<br />
It is good to use <mark style="background-color&#x3a; &num;f5f2f0;">client.waitForAllResponses()</mark> before <mark style="background-color&#x3a; &num;f5f2f0;">disconnect()</mark>, to not break connection before all responses comes back.<br /></p>

<h3>Listner</h3>

<p>Listener is also a client (it should works on different account) that subscribes to receiving events from specific nodes of PubSub component. PubSub items received by <mark style="background-color&#x3a; &num;f5f2f0;">PubSubModule</mark> are distributed in the client as <mark style="background-color&#x3a; &num;f5f2f0;">PubSubEventReceivedEvent</mark> in Event Bus. To receive those events you have to register an events listener:<br /></p>

<pre><b>

client.eventBus.register(PubSubEventReceivedEvent.TYPE) {
    if (it.pubSubJID == PUBSUB_JID &amp;&amp; it.nodeName == PUBSUB_NODE) {
        it.items.forEach { item -&gt;
            val publishedContent = item.getFirstChild("temperature")!!
            val date = Date(publishedContent.attributes["timestamp"]!!.toLong())
            val value = publishedContent.value!!
            println("Received update: $date :: $value<sup>o</sup>C")
        }
    }
}</b></pre>

<p>Note, that this listener will be called on every received PubSub event (like OMEMO keys distribution, PEP events, etc). That’s why you need to check node name and JabberID of PubSub component.<br /></p>

<p>Your client will not receive anything from PubSub if it does not subscribe to specific node. Because subscription is persistent (at least with default node configuration), client doesn’t need to subscribe every time it connects to the server. Though, it should be able to check if it’s subscribed to the specific node or not. For that, you need to retrieve list of subscribers and see if the JabberID of the client is on the list:<br /></p>

<pre><b>
val myOwnJID = client.getModule(BindModule.TYPE)!!.boundJID!!
pubSubModule.retrieveSubscriptions(PUBSUB_JID, PUBSUB_NODE).response {
if (!it.get()!!.any { subscription -&gt; subscription.jid.bareJID == myOwnJID.bareJID })
  {
    println("We have to subscribe")
    pubSubModule.subscribe(PUBSUB_JID, PUBSUB_NODE, myOwnJID).send()
  }
}.send()
</b></pre>

<p>NOTE: In this example we intentionally skipped checking response errors.<br /></p>

<p>PubSub component can keep some history of published elements. We can retrieve that list easily:<br /></p>

<pre><b>
pubSubModule.retrieveItem(PUBSUB_JID, PUBSUB_NODE).response {
    when (it) {
        is IQResult.Success -&gt; {
            println("Previously published temperatures:")
            it.get()!!.items.forEach {
                val date = Date(it.content!!.attributes["timestamp"]!!.toLong())
                val value = it.content!!.value!!
                println(" - $date :: $value<sup>o</sup>C")
            }
        }
        is IQResult.Error -&gt; println("OOPS! Error " + it.error)
    }
}.send()
</b></pre>

<p>Length of the history is defined in node configuration.<br /></p>

<h3>Sample output</h3>

<p>Submitting new temperature in <mark style="background-color&#x3a; &num;f5f2f0;">Publisher </mark>…:<br /></p>

<center><img src="http://localhost:4000assets/img/blog/halcyon-pubsub-publisher-run.png" style="width:50%;" /><br /><br /></center>
<p><br /></p>

<p>yields receiving notifications in <mark style="background-color&#x3a; &num;f5f2f0;">Listener:</mark><br /></p>

<center><img src="http://localhost:4000assets/img/blog/halcyon-pubsub-listener-listen.png" style="width:50%;" /><br /><br /></center>
<p><br /></p>

<h3>Summary</h3>
<p>We presented a simple way to create a PubSub publisher and consumer. You can extend it: for example you can run publisher on Raspberry Pi connected to some meteo-sensors. Possible applications of PubSub component are limited only by your imagination.<br /></p>

<p>All source codes for this article can be found in <a href="https://github.com/tigase/halcyon-examples/tree/master/article-pubsub" style="color:#5a66e8;" target="_blank">GitHub repository</a>.</p>

                        </div>
                    </div>
                    <!-- /.card -->
                </div>
                <!-- /.blog -->
            </div>
            <!-- /column -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container -->
</section>
<!-- /section -->

<footer class="bg-navy text-inverse">
    <div class="container pt-15 pt-md-17 pb-13 pb-md-15">
        <div class="d-lg-flex flex-row align-items-lg-center">
            <h3 class="display-4 mb-6 mb-lg-0 pe-lg-20 pe-xl-22 pe-xxl-25 text-white" style="text-align:left;">Getting started with using XMPP never been easier - pick a project you want to build, and let XMPP safely and robustly store your data.</h3>
            <a href="download" class="btn btn-primary rounded-pill mb-0 text-nowrap">Try It For Free</a>
        </div>
        <!--/div -->
        <hr class="mt-11 mb-12" />
        <div class="row gy-6 gy-lg-0">
            <div class="col-md-4 col-lg-3">
                <div class="widget">
                    <a href="index.html"><img class="mb-4" src="http://localhost:4000assets/img/logow.png" alt="" /></a>

                    <p class="mb-4">© 2021 Tigase. <br class="d-none d-lg-block" />All rights reserved.</p>
                    <nav class="nav social social-white">
                        <a href="https://www.twitter.com/tigase" target="_blank"><i class="uil uil-twitter"></i></a>
                        <a href="https://www.facebook.com/tigase" target="_blank"><i class="uil uil-facebook-f"></i></a>

                    </nav>
                    <!-- /.social -->
                </div>
                <!-- /.widget -->
            </div>
            <!-- /column -->
            <div class="col-md-4 col-lg-3">
                <div class="widget">
                    <h4 class="widget-title text-white mb-3"><a href="https://github.com/tigase/tigase-server/issues" target="_blank">Get in Touch</a></h4>
                    <address class="pe-xl-15 pe-xxl-17">4275 Executive Sq., Suite 200, La Jolla, CA 92037</address>
                    <!--<a href="mailto:info@tigase.net">info@tigase.net</a><br /> <a href="tel:+14159004778">+1 (415) 900-4778</a>-->
                </div>
                <!-- /.widget -->
            </div>
            <!-- /column -->
            <div class="col-md-4 col-lg-3">
                <div class="widget">
                    <h4 class="widget-title text-white mb-3">XMPP Software</h4>
                    <ul class="list-unstyled mb-0">
                        <li>
                            <a href="https://github.com/tigase/tigase-server" target="_blank">XMPP Server Project</a>
                        </li>
                        <!--<li>
                            <a href="#">XMPP Clients</a>
                        </li>
                        <li>
                            <a href="#">XMPP Libraries</a>
                        </li>-->

                    </ul>
                </div>
                <!-- /.widget -->
            </div>
            <!-- /column -->
            <div class="col-md-12 col-lg-3">
                <div class="widget">
                    <h4 class="widget-title text-white mb-3">Newsletter</h4>
                    <p class="mb-5">

                    <p>Subscribe to TIGASE Stay up to date with news and updates in our software</p>
                    </p>
                    <div class="newsletter-wrapper">
                        <!-- Begin Mailchimp Signup Form -->
                        <div id="mc_embed_signup2">
                            <form action="#" method="post">
                                <div id="mc_embed_signup_scroll2">
                                    <div class="mc-field-group input-group form-label-group">
                                        <input type="email" value="" name="EMAIL" class="required email form-control" placeholder="Email Address" id="mce-EMAIL2">
                                        <label for="mce-EMAIL2">Email Address</label>
                                        <input type="submit" value="Join" name="subscribe" id="mc-embedded-subscribe2" class="btn btn-primary">
                                    </div>
                                    <div id="mce-responses2" class="clear">
                                        <div class="response" id="mce-error-response2" style="display:none"></div>
                                        <div class="response" id="mce-success-response2" style="display:none"></div>
                                    </div> <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_ddc180777a163e0f9f66ee014_4b1bcfa0bc" tabindex="-1" value=""></div>
                                    <div class="clear"></div>
                                </div>
                            </form>
                        </div>
                        <!--End mc_embed_signup-->
                    </div>
                    <!-- /.newsletter-wrapper -->
                </div>
                <!-- /.widget -->
            </div>
            <!-- /column -->
        </div>
        <!--/.row -->
    </div>
    <!-- /.container -->
</footer>


<div class="progress-wrap">
    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98" />
    </svg>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>


<!-- <script src="http://localhost:4000assets/js/bootstrap.bundle.min.js"></script> -->

<script src="http://localhost:4000assets/js/jquery.min.js"></script>
<script src="http://localhost:4000assets/js/plugins.js"></script>
<script src="http://localhost:4000assets/js/theme.js"></script>

    <script>
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                    pageLanguage: 'en'
                },
                'google_translate_element'
            );
        }
    </script>
    <script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

